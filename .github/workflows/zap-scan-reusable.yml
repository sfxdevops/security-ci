name: Reusable ZAP Security Scan

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to scan (snapshot-preprod, prod, etc.)'
        required: true
        type: string
      app_name:
        description: 'Application name (e.g., biosmartx)'
        required: true
        type: string
      service_name:
        description: 'Service name (e.g., nin-processing-queue)'
        required: true
        type: string
      wait_time:
        description: 'Seconds to wait for deployment to stabilize'
        required: false
        type: number
        default: 90
    secrets:
      DEFECTDOJO_URL:
        required: true
      DEFECTDOJO_API_KEY:
        required: true
      DEFECTDOJO_ENGAGEMENT_PREPROD:
        required: false
      DEFECTDOJO_ENGAGEMENT_DEV:
        required: false

permissions:
  actions: read
  contents: read
  security-events: write        

jobs:
  zap-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout security scripts
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install requests
        sudo apt-get update && sudo apt-get install -y jq
    
    - name: Configure scan parameters
      run: |
        ENV="${{ inputs.environment }}"
        APP="${{ inputs.app_name }}"
        SERVICE="${{ inputs.service_name }}"
        
        case "$ENV" in
          dev)
            TARGET_URL="https://seamtel-dev.seamfix.com.ng"  
            ENGAGEMENT_ID="${{ secrets.DEFECTDOJO_ENGAGEMENT_DEV }}"
            ;;
          snapshot-preprod|preprod)
            TARGET_URL="https://seamtel-preprod.seamfix.com.ng"
            ENGAGEMENT_ID="${{ secrets.DEFECTDOJO_ENGAGEMENT_PREPROD }}"
            ;;
          prod)
            TARGET_URL="https://seamtel.seamfix.com.ng"
            ENGAGEMENT_ID="${{ secrets.DEFECTDOJO_ENGAGEMENT_PROD }}"
            ;;
          *)
            echo "::error::Unknown environment: $ENV"
            exit 1
            ;;
        esac
        
        echo "TARGET_URL=$TARGET_URL" >> "$GITHUB_ENV"
        echo "ENGAGEMENT_ID=$ENGAGEMENT_ID" >> "$GITHUB_ENV"
        
        echo "### ZAP Scan Configuration" >> "$GITHUB_STEP_SUMMARY"
        echo "- **Target URL**: $TARGET_URL" >> "$GITHUB_STEP_SUMMARY"
        echo "- **Environment**: $ENV" >> "$GITHUB_STEP_SUMMARY"
        echo "- **Application**: $APP" >> "$GITHUB_STEP_SUMMARY"
        echo "- **Service**: $SERVICE" >> "$GITHUB_STEP_SUMMARY"
        echo "- **Engagement ID**: $ENGAGEMENT_ID" >> "$GITHUB_STEP_SUMMARY"
    
    - name: Wait for Argo CD deployment
      run: |
        echo "Waiting ${{ inputs.wait_time }} seconds for Argo CD to sync and app to stabilize..."
        sleep ${{ inputs.wait_time }}
    
    - name: Check if application is reachable
      run: |
        MAX_ATTEMPTS=30
        ATTEMPT=1
        
        echo "Checking if $TARGET_URL is reachable..."
        
        IS_REACHABLE=false
        while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${TARGET_URL}/health" 2>/dev/null || echo "000")
          
          if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "404" ] || [ "$HTTP_CODE" == "401" ]; then
            echo "âœ“ Application is reachable (HTTP $HTTP_CODE)"
            IS_REACHABLE=true
            break
          fi
          
          echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - HTTP $HTTP_CODE - Waiting..."
          sleep 10
          ATTEMPT=$((ATTEMPT + 1))
        done
        
        if [ "$IS_REACHABLE" = "false" ]; then
          echo "::warning::Application not reachable after $MAX_ATTEMPTS attempts"
        fi
        
        echo "IS_REACHABLE=$IS_REACHABLE" >> "$GITHUB_ENV"
    
    - name: Run ZAP Baseline Scan
      if: env.IS_REACHABLE == 'true'
      run: |
        set +e
        
        REPORT_DIR="./zap-reports"
        mkdir -p "$REPORT_DIR"
        
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        REPORT_XML="$REPORT_DIR/zap-report-$TIMESTAMP.xml"
        REPORT_HTML="$REPORT_DIR/zap-report-$TIMESTAMP.html"
        
        echo "Starting ZAP scan against $TARGET_URL"
        
        docker run --rm \
          -v "$(pwd)/$REPORT_DIR:/zap/wrk:rw" \
          --name zap-scanner \
          -u 0:0 \
          zaproxy/zap-stable:latest \
          zap-baseline.py \
          -t "$TARGET_URL" \
          -x "zap-report-$TIMESTAMP.xml" \
          -r "zap-report-$TIMESTAMP.html" \
          -I
        
        ZAP_EXIT_CODE=$?
        echo "ZAP scan completed with exit code: $ZAP_EXIT_CODE"
        
        # Parse XML for summary - FIXED: Don't use || echo "0"
        if [ -f "$REPORT_XML" ]; then
          HIGH_COUNT=$(grep -c 'riskcode="3"' "$REPORT_XML" 2>/dev/null)
          if [ $? -ne 0 ]; then HIGH_COUNT=0; fi
          
          MEDIUM_COUNT=$(grep -c 'riskcode="2"' "$REPORT_XML" 2>/dev/null)
          if [ $? -ne 0 ]; then MEDIUM_COUNT=0; fi
          
          LOW_COUNT=$(grep -c 'riskcode="1"' "$REPORT_XML" 2>/dev/null)
          if [ $? -ne 0 ]; then LOW_COUNT=0; fi
        else
          HIGH_COUNT=0
          MEDIUM_COUNT=0
          LOW_COUNT=0
        fi
        
        echo "ZAP_REPORT_XML=$REPORT_XML" >> "$GITHUB_ENV"
        echo "ZAP_REPORT_HTML=$REPORT_HTML" >> "$GITHUB_ENV"
        echo "ZAP_EXIT_CODE=$ZAP_EXIT_CODE" >> "$GITHUB_ENV"
        echo "ZAP_HIGH_COUNT=$HIGH_COUNT" >> "$GITHUB_ENV"
        echo "ZAP_MEDIUM_COUNT=$MEDIUM_COUNT" >> "$GITHUB_ENV"
        echo "ZAP_LOW_COUNT=$LOW_COUNT" >> "$GITHUB_ENV"
        
        echo "Scan variables set:"
        echo "  Report XML: $REPORT_XML"
        echo "  Report HTML: $REPORT_HTML"
        echo "  Exit code: $ZAP_EXIT_CODE"
        echo "  High: $HIGH_COUNT, Medium: $MEDIUM_COUNT, Low: $LOW_COUNT"
        
        set -e
    
    - name: Upload results to DefectDojo
      if: env.IS_REACHABLE == 'true'
      continue-on-error: true
      run: |
        echo "Attempting to upload report: $ZAP_REPORT_XML"
        
        if [ ! -f "$ZAP_REPORT_XML" ]; then
          echo "::error::Report file not found: $ZAP_REPORT_XML"
          exit 1
        fi
        
        if [ -f "scripts/defectdojo-import.py" ]; then
          python3 scripts/defectdojo-import.py \
            --report "$ZAP_REPORT_XML" \
            --url "${{ secrets.DEFECTDOJO_URL }}" \
            --api-key "${{ secrets.DEFECTDOJO_API_KEY }}" \
            --engagement-id "$ENGAGEMENT_ID" \
            --scan-type "ZAP Scan" \
            --environment "${{ inputs.environment }}" \
            --app-name "${{ inputs.app_name }}" \
            --service-name "${{ inputs.service_name }}"
        else
          echo "::warning::DefectDojo import script not found at scripts/defectdojo-import.py"
        fi
    
    - name: Upload ZAP reports as artifacts
      uses: actions/upload-artifact@v4
      if: always() && env.IS_REACHABLE == 'true'
      with:
        name: zap-reports-${{ inputs.environment }}-${{ inputs.service_name }}
        path: zap-reports/*
        retention-days: 30
    
    - name: Generate scan summary
      if: always() && env.IS_REACHABLE == 'true'
      run: |
        EXIT_CODE=${ZAP_EXIT_CODE:-0}
        HIGH=${ZAP_HIGH_COUNT:-0}
        MEDIUM=${ZAP_MEDIUM_COUNT:-0}
        LOW=${ZAP_LOW_COUNT:-0}
        
        echo "## ZAP Scan Results ðŸ”’" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "**Target**: $TARGET_URL" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        echo "### Vulnerabilities Found" >> "$GITHUB_STEP_SUMMARY"
        echo "- ðŸ”´ High: $HIGH" >> "$GITHUB_STEP_SUMMARY"
        echo "- ðŸŸ¡ Medium: $MEDIUM" >> "$GITHUB_STEP_SUMMARY"
        echo "- ðŸ”µ Low: $LOW" >> "$GITHUB_STEP_SUMMARY"
        echo "" >> "$GITHUB_STEP_SUMMARY"
        
        if [ "$EXIT_CODE" -ge 2 ]; then
          echo "### âš ï¸ CRITICAL VULNERABILITIES DETECTED" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "High or critical risk vulnerabilities were found!" >> "$GITHUB_STEP_SUMMARY"
          echo "Please review the findings in DefectDojo: ${{ secrets.DEFECTDOJO_URL }}" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "### âœ… No Critical Issues" >> "$GITHUB_STEP_SUMMARY"
          echo "No high or critical vulnerabilities detected." >> "$GITHUB_STEP_SUMMARY"
        fi
    
    - name: Fail if critical vulnerabilities found
      if: env.IS_REACHABLE == 'true'
      run: |
        EXIT_CODE=${ZAP_EXIT_CODE:-0}
        
        if [ "$EXIT_CODE" -ge 2 ]; then
          echo "::error::Critical vulnerabilities detected in ${{ inputs.environment }}!"
          echo "::error::Review DefectDojo: ${{ secrets.DEFECTDOJO_URL }}"
          echo "::error::High risk count: ${ZAP_HIGH_COUNT:-0}"
          exit 1
        fi
        
        echo "âœ“ No critical vulnerabilities found (exit code: $EXIT_CODE)"
