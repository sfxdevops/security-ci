name: Reusable ZAP Security Scan

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to scan (snapshot-preprod, prod, etc.)'
        required: true
        type: string
      app_name:
        description: 'Application name (e.g., biosmartx)'
        required: true
        type: string
      service_name:
        description: 'Service name (e.g., nin-processing-queue)'
        required: true
        type: string
      wait_time:
        description: 'Seconds to wait for deployment to stabilize'
        required: false
        type: number
        default: 90
    secrets:
      DEFECTDOJO_URL:
        required: true
      DEFECTDOJO_API_KEY:
        required: true
      DEFECTDOJO_ENGAGEMENT_PREPROD:
        required: false
      DEFECTDOJO_ENGAGEMENT_DEV:
        required: false

permissions:
  actions: read
  contents: read
  security-events: write        

jobs:
  zap-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout security scripts
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install requests
        sudo apt-get update && sudo apt-get install -y jq
    
    - name: Configure scan parameters
      id: config
      run: |
        set +e
        
        ENV="${{ inputs.environment }}"
        APP="${{ inputs.app_name }}"
        SERVICE="${{ inputs.service_name }}"
        
        case "$ENV" in
          dev)
            TARGET_URL="https://seamtel-dev.seamfix.com.ng"  
            ENGAGEMENT_ID="${{ secrets.DEFECTDOJO_ENGAGEMENT_DEV }}"
            ;;
          snapshot-preprod|preprod)
            TARGET_URL="https://seamtel-preprod.seamfix.com.ng"
            ENGAGEMENT_ID="${{ secrets.DEFECTDOJO_ENGAGEMENT_PREPROD }}"
            ;;
          prod)
            TARGET_URL="https://seamtel.seamfix.com.ng"
            ENGAGEMENT_ID="${{ secrets.DEFECTDOJO_ENGAGEMENT_PROD }}"
            ;;
          *)
            echo "::error::Unknown environment: $ENV"
            exit 1
            ;;
        esac
        
        cat >> "$GITHUB_OUTPUT" << ENDCONFIG
target_url=$TARGET_URL
engagement_id=$ENGAGEMENT_ID
ENDCONFIG
        
        cat >> "$GITHUB_STEP_SUMMARY" << ENDSUMMARY
### ZAP Scan Configuration
- **Target URL**: $TARGET_URL
- **Environment**: $ENV
- **Application**: $APP
- **Service**: $SERVICE
- **Engagement ID**: $ENGAGEMENT_ID
ENDSUMMARY
    
    - name: Wait for Argo CD deployment
      run: |
        echo "Waiting ${{ inputs.wait_time }} seconds for Argo CD to sync..."
        sleep ${{ inputs.wait_time }}
    
    - name: Check if application is reachable
      id: health_check
      run: |
        set +e
        
        TARGET_URL="${{ steps.config.outputs.target_url }}"
        MAX_ATTEMPTS=30
        ATTEMPT=1
        
        echo "Checking if $TARGET_URL is reachable..."
        
        while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${TARGET_URL}/health" 2>/dev/null || echo "000")
          
          if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "404" ] || [ "$HTTP_CODE" == "401" ]; then
            echo "âœ“ Application is reachable (HTTP $HTTP_CODE)"
            echo "is_reachable=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          echo "Attempt $ATTEMPT/$MAX_ATTEMPTS - HTTP $HTTP_CODE - Waiting..."
          sleep 10
          ATTEMPT=$((ATTEMPT + 1))
        done
        
        echo "::warning::Application not reachable after $MAX_ATTEMPTS attempts"
        echo "is_reachable=false" >> "$GITHUB_OUTPUT"
    
    - name: Run ZAP Baseline Scan
      id: zap_scan
      if: steps.health_check.outputs.is_reachable == 'true'
      run: |
        set +e
        
        TARGET_URL="${{ steps.config.outputs.target_url }}"
        REPORT_DIR="./zap-reports"
        mkdir -p "$REPORT_DIR"
        
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        REPORT_XML="${REPORT_DIR}/zap-report-${TIMESTAMP}.xml"  
        REPORT_HTML="${REPORT_DIR}/zap-report-${TIMESTAMP}.html"
        
        echo "Starting ZAP scan against $TARGET_URL"
        
        docker run --rm \
          -v "$(pwd)/${REPORT_DIR}:/zap/wrk:rw" \
          --name zap-scanner \
          -u 0:0 \
          zaproxy/zap-stable:latest \
          zap-baseline.py \
          -t "$TARGET_URL" \
          -x "zap-report-${TIMESTAMP}.xml" \
          -r "zap-report-${TIMESTAMP}.html" \
          -I
        
        ZAP_EXIT_CODE=$?
        echo "ZAP scan completed with exit code: ${ZAP_EXIT_CODE}"
        
        if [ -f "$REPORT_XML" ]; then
          HIGH_COUNT=$(grep -c 'riskcode="3"' "$REPORT_XML" 2>/dev/null || echo "0")
          MEDIUM_COUNT=$(grep -c 'riskcode="2"' "$REPORT_XML" 2>/dev/null || echo "0")
          LOW_COUNT=$(grep -c 'riskcode="1"' "$REPORT_XML" 2>/dev/null || echo "0")
        else
          HIGH_COUNT=0
          MEDIUM_COUNT=0
          LOW_COUNT=0
        fi
        
        cat >> "$GITHUB_OUTPUT" << ENDSCAN
zap_exit_code=$ZAP_EXIT_CODE
report_xml=$REPORT_XML
report_html=$REPORT_HTML
high_count=$HIGH_COUNT
medium_count=$MEDIUM_COUNT
low_count=$LOW_COUNT
ENDSCAN
    
    - name: Upload results to DefectDojo
      if: steps.health_check.outputs.is_reachable == 'true'
      continue-on-error: true
      run: |
        if [ -f "scripts/defectdojo-import.py" ]; then
          python3 scripts/defectdojo-import.py \
            --report "${{ steps.zap_scan.outputs.report_xml }}" \
            --url "${{ secrets.DEFECTDOJO_URL }}" \
            --api-key "${{ secrets.DEFECTDOJO_API_KEY }}" \
            --engagement-id "${{ steps.config.outputs.engagement_id }}" \
            --scan-type "ZAP Scan" \
            --environment "${{ inputs.environment }}" \
            --app-name "${{ inputs.app_name }}" \
            --service-name "${{ inputs.service_name }}"
        else
          echo "::warning::DefectDojo import script not found"
        fi
    
    - name: Upload ZAP reports as artifacts
      uses: actions/upload-artifact@v4
      if: always() && steps.health_check.outputs.is_reachable == 'true'
      with:
        name: zap-reports-${{ inputs.environment }}-${{ inputs.service_name }}
        path: zap-reports/*
        retention-days: 30
    
    - name: Generate scan summary
      if: always() && steps.health_check.outputs.is_reachable == 'true'
      run: |
        ZAP_EXIT_CODE="${{ steps.zap_scan.outputs.zap_exit_code }}"
        HIGH="${{ steps.zap_scan.outputs.high_count }}"
        MEDIUM="${{ steps.zap_scan.outputs.medium_count }}"
        LOW="${{ steps.zap_scan.outputs.low_count }}"
        
        : ${ZAP_EXIT_CODE:=0}
        : ${HIGH:=0}
        : ${MEDIUM:=0}
        : ${LOW:=0}
        
        cat >> "$GITHUB_STEP_SUMMARY" << ENDSUMMARY
## ZAP Scan Results ðŸ”’

**Target**: ${{ steps.config.outputs.target_url }}

### Vulnerabilities Found
- ðŸ”´ High: ${HIGH}
- ðŸŸ¡ Medium: ${MEDIUM}
- ðŸ”µ Low: ${LOW}

ENDSUMMARY
        
        if [ "$ZAP_EXIT_CODE" -ge 2 ]; then
          cat >> "$GITHUB_STEP_SUMMARY" << ENDWARNING
### âš ï¸ CRITICAL VULNERABILITIES DETECTED

High or critical risk vulnerabilities were found!
Please review the findings in DefectDojo: ${{ secrets.DEFECTDOJO_URL }}
ENDWARNING
        else
          cat >> "$GITHUB_STEP_SUMMARY" << ENDOK
### âœ… No Critical Issues
No high or critical vulnerabilities detected.
ENDOK
        fi
    
    - name: Fail if critical vulnerabilities found
      if: steps.health_check.outputs.is_reachable == 'true'
      run: |
        ZAP_EXIT_CODE="${{ steps.zap_scan.outputs.zap_exit_code }}"
        : ${ZAP_EXIT_CODE:=0}
        
        if [ "$ZAP_EXIT_CODE" -ge 2 ]; then
          echo "::error::Critical vulnerabilities detected in ${{ inputs.environment }}!"
          echo "::error::Review DefectDojo: ${{ secrets.DEFECTDOJO_URL }}"
          echo "::error::High risk count: ${{ steps.zap_scan.outputs.high_count }}"
          exit 1
        fi
        
        echo "âœ“ No critical vulnerabilities found"
